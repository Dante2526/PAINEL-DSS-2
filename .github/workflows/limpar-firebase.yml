name: Limpar Checkboxes (Manual e Agendado 2x2)

on:
  # 1. O botão manual (para rodar quando você quiser)
  workflow_dispatch: 

  # 2. O agendamento (Roda TODO DIA às 04:00 UTC, que é 01:00 da manhã em Brasília)
  schedule:
    - cron: '0 4 * * *'

jobs:
  limpar-dados-firebase:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      # ----- ESTE É O NOVO PASSO MÁGICO -----
      - name: Verificar se é dia de trabalho (Ciclo 2x2)
        id: verificar-dia # Demos um ID para este passo
        run: |
          # 1. Definimos a data "base" (um dia que sabemos que você trabalhou)
          #    Vamos usar a data de amanhã (7 de Nov de 2025) como o "Dia 0" do ciclo
          ANCHOR_DATE="2025-11-07"
          
          # 2. Pegamos os segundos da data base e da data de hoje
          #    O 'date' do GitHub Actions roda em UTC, que é o que o 'cron' usa
          ANCHOR_SECONDS=$(date -d "$ANCHOR_DATE" +%s)
          CURRENT_SECONDS=$(date +%s)
          
          # 3. Calculamos quantos dias se passaram (86400 segundos = 1 dia)
          DIFF_DAYS=$(((CURRENT_SECONDS - ANCHOR_SECONDS) / 86400))
          
          # 4. Descobrimos em que ponto do ciclo de 4 dias estamos
          #    O resultado será 0, 1, 2, ou 3
          #    O '%%' é como o % funciona em scripts
          CYCLE_DAY=$((DIFF_DAYS %% 4))
          
          # 5. O seu ciclo é:
          #    Dia 0 = Trabalho (ex: 7/Nov)
          #    Dia 1 = Trabalho (ex: 8/Nov)
          #    Dia 2 = Folga    (ex: 9/Nov)
          #    Dia 3 = Folga    (ex: 10/Nov)
          
          if [[ $CYCLE_DAY -eq 0 || $CYCLE_DAY -eq 1 ]]; then
            echo "Hoje é um dia de TRABALHO (Dia $CYCLE_DAY do ciclo). O script VAI rodar."
            # Isso "avisa" os próximos passos que eles devem rodar
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Hoje é um dia de FOLGA (Dia $CYCLE_DAY do ciclo). O script NÃO vai rodar."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      # Este passo SÓ VAI RODAR SE o passo anterior disser "should_run=true"
      - name: Instalar dependências
        if: steps.verificar-dia.outputs.should_run == 'true'
        run: npm install

      # Este passo SÓ VAI RODAR SE for um dia de trabalho
      - name: Rodar script de limpeza
        if: steps.verificar-dia.outputs.should_run == 'true'
        run: node scripts/limpar-firebase.cjs 
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
