name: Limpar Checkboxes (Manual e Agendado 2x2)

on:
  # 1. O botão manual
  workflow_dispatch: 

  # 2. O agendamento (04:00 UTC = 01:00 da manhã em Brasília)
  schedule:
    - cron: '0 4 * * *'

jobs:
  limpar-dados-firebase:
    runs-on: ubuntu-latest

    steps:
      # NOME CORRETO: Checkout código
      - name: Checkout código
        uses: actions/checkout@v4

      # NOME CORRETO: Verificar se é dia de trabalho (Ciclo 2x2)
      - name: Verificar se é dia de trabalho (Ciclo 2x2)
        id: verificar-dia 
        run: |
          # Data base: 7 de Novembro de 2025 (Seu dia de trabalho atual)
          # ANCHOR_DATE="2025-11-07"
          # Atualizando para a data de hoje (7/Nov) que você confirmou que é trabalho
          ANCHOR_DATE=$(date +%Y-%m-%d)

          ANCHOR_SECONDS=$(date -d "$ANCHOR_DATE" +%s)
          CURRENT_SECONDS=$(date +%s)
          
          DIFF_DAYS=$(((CURRENT_SECONDS - ANCHOR_SECONDS) / 86400))
          CYCLE_DAY=$((DIFF_DAYS %% 4))
          
          # Se o resultado for 0 ou 1, é dia de trabalho (2/2 ciclo)
          if [[ $CYCLE_DAY -eq 0 || $CYCLE_DAY -eq 1 ]]; then
            echo "Hoje é um dia de TRABALHO (Dia $CYCLE_DAY do ciclo). O script VAI rodar."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Hoje é um dia de FOLGA (Dia $CYCLE_DAY do ciclo). O script NÃO vai rodar."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      # NOME CORRETO: Instalar dependências
      - name: Instalar dependências
        if: steps.verificar-dia.outputs.should_run == 'true'
        run: npm install

      # NOME CORRETO: Rodar script de limpeza
      - name: Rodar script de limpeza
        if: steps.verificar-dia.outputs.should_run == 'true'
        run: node scripts/limpar-firebase.cjs 
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
