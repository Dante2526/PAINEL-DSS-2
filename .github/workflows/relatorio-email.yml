name: Enviar Relatório por E-mail (Agendado 2x2)

on:
  workflow_dispatch: 
  schedule:
    - cron: '0 13 * * *' # 10h da manhã BRT

jobs:
  enviar-relatorio-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código (com defeito)
        uses: actions/checkout@v4

      # --- AQUI ESTÁ A CORREÇÃO (O "DEDO-DURO" DA PASTA) ---
      - name: Mostrar onde os arquivos estão (Debug)
        run: ls -R

      # --- AQUI ESTÁ A CORREÇÃO (A "VOLTA") ---
      - name: Mover para a pasta do código (Correção)
        # Entra na pasta duplicada que o checkout criou
        run: cd $GITHUB_WORKSPACE/PAINEL-DSS-2
        # Define esta pasta como o local de trabalho para os próximos passos
        working-directory: ./PAINEL-DSS-2

      # Este passo agora roda DENTRO da pasta correta
      - name: Verificar se é dia de trabalho OU teste manual
        id: verificar-dia
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          # (O resto do script de verificação...)
          if [[ "$GITHUB_EVENT_NAME" == "workflow_dispatch" ]]; then
            echo "É um TESTE MANUAL. O relatório VAI ser enviado."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "É uma execução AGENDADA. Verificando o ciclo 2x2..."
            ANCHOR_DATE="2025-11-07"
            ANCHOR_SECONDS=$(date -d "$ANCHOR_DATE" +%s)
            CURRENT_SECONDS=$(date +%s)
            DIFF_DAYS=$(((CURRENT_SECONDS - ANCHOR_SECONDS) / 86400))
            CYCLE_DAY=$((DIFF_DAYS % 4))
            if [[ $CYCLE_DAY -eq 0 || $CYCLE_DAY -eq 1 ]]; then
              echo "Hoje é dia de TRABALHO. O relatório VAI ser enviado."
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "Hoje é dia de FOLGA. O relatório NÃO vai ser enviado."
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi
        # IMPORTANTE: Diz a este passo para rodar na pasta correta
        working-directory: ./PAINEL-DSS-2

      # Este passo SÓ RODA se a verificação (manual ou agendada) passar
      - name: Instalar dependências
        if: steps.verificar-dia.outputs.should_run == 'true'
        run: npm install
        # IMPORTANTE: Diz a este passo para rodar na pasta correta
        working-directory: ./PAINEL-DSS-2

      # Este passo SÓ RODA se a verificação (manual ou agendada) passar
      - name: Rodar script de envio de e-mail
        if: steps.verificar-dia.outputs.should_run == 'true'
        # O caminho agora é mais simples (só "scripts/...")
        run: node scripts/enviar-relatorio.cjs 
        env:
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        # IMPORTANTE: Diz a este passo para rodar na pasta correta
        working-directory: ./PAINEL-DSS-2
