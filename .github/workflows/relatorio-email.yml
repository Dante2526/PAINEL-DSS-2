name: Enviar Relatório por E-mail (Agendado 2x2)

on:
  # 1. Botão manual (para testar)
  workflow_dispatch: 

  # 2. O agendamento (13:00 UTC = 10:00 da manhã em Brasília)
  schedule:
    - cron: '0 13 * * *'

jobs:
  enviar-relatorio-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      # Exatamente a mesma lógica de verificação 2x2
      - name: Verificar se é dia de trabalho (Ciclo 2x2)
        id: verificar-dia 
        run: |
          # Data base: 7 de Novembro de 2025 (Dia que sabemos que é TRABALHO)
          ANCHOR_DATE="2025-11-07"
          
          ANCHOR_SECONDS=$(date -d "$ANCHOR_DATE" +%s)
          CURRENT_SECONDS=$(date +%s)
          
          DIFF_DAYS=$(((CURRENT_SECONDS - ANCHOR_SECONDS) / 86400))
          # Corrigido para % (um sinal de porcentagem)
          CYCLE_DAY=$((DIFF_DAYS % 4))
          
          if [[ $CYCLE_DAY -eq 0 || $CYCLE_DAY -eq 1 ]]; then
            echo "Hoje é um dia de TRABALHO (Dia $CYCLE_DAY do ciclo). O relatório VAI ser enviado."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Hoje é um dia de FOLGA (Dia $CYCLE_DAY do ciclo). O relatório NÃO vai ser enviado."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      # Este passo SÓ RODA se for dia de trabalho
      - name: Instalar dependências
        if: steps.verificar-dia.outputs.should_run == 'true'
        run: npm install

      # Este passo SÓ RODA se for dia de trabalho
      - name: Rodar script de envio de e-mail
        if: steps.verificar-dia.outputs.should_run == 'true'
        # --- ATENÇÃO AQUI: Estamos a chamar o novo script ---
        run: node scripts/enviar-relatorio.cjs 
        env:
          # Precisa de TODOS os secrets: Firebase e E-mail
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
